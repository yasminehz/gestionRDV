{% extends 'base.html.twig' %}

{% block title %}Nouvelle indisponibilité{% endblock %}

{% block body %}
<h1>Nouvelle indisponibilité</h1>

{{ include('indisponibilite/_form.html.twig', {'existing': existing}) }}

<h3 class="mt-4">Indisponibilités existantes</h3>
<ul>
	{% for i in existing %}
		<li>{{ i.debut ? i.debut|date('d/m/Y H:i') : '' }} — {{ i.fin ? i.fin|date('d/m/Y H:i') : '' }} {% if i.motif %} ({{ i.motif }}){% endif %}</li>
	{% else %}
		<li>Aucune</li>
	{% endfor %}
</ul>

<a href="{{ path('indisponibilite_index') }}">Retour</a>

<script>
// Re-init datetime pickers with disabled ranges from existing indisponibilites
(function(){
		if (typeof flatpickr !== 'function') return;
		var existing = {{ existing is defined ? existing|json_encode : '[]'|raw }};
		// build disable ranges in flatpickr format
		var ranges = existing.map(function(it){
				// entity JSON may contain date strings — try to read debut/fin
				return {
						from: it.debut ? it.debut.replace(' ', 'T') : null,
						to: it.fin ? it.fin.replace(' ', 'T') : null
				};
		}).filter(function(r){ return r.from && r.to; });

		document.querySelectorAll('input.js-datetime').forEach(function(el){
				try { if (el._flatpickr) el._flatpickr.destroy(); } catch(e){}
				flatpickr(el, Object.assign({
						enableTime: true,
						time_24hr: true,
						dateFormat: 'Y-m-d H:i',
						altInput: true,
						altFormat: 'd/m/Y H:i',
				}, ranges.length ? {disable: ranges} : {}));
		});
})();
</script>

{% endblock %}
